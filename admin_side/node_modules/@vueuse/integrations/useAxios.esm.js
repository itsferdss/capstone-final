import { shallowRef, ref } from 'vue-demi';
import axios from 'axios';

/**
 * Wrapper for axios.
 *
 * @see https://vueuse.org/useAxios
 * @param url
 * @param config
 */
function useAxios(url, ...args) {
    let config = {};
    let instance = axios;
    if (args.length > 0) {
        /**
         * Unable to use `instanceof` here becuase of (https://github.com/axios/axios/issues/737)
         * so instead we are checking if there is a `requset` on the object to see if it is an
         * axios instance
         */
        if ('request' in args[0])
            instance = args[0];
        else
            config = args[0];
    }
    if (args.length > 1) {
        if ('request' in args[1])
            instance = args[1];
    }
    const response = shallowRef();
    const data = shallowRef();
    const isFinished = ref(false);
    const isLoading = ref(true);
    const aborted = ref(false);
    const error = shallowRef();
    const cancelToken = axios.CancelToken.source();
    const abort = (message) => {
        if (isFinished.value || !isLoading.value)
            return;
        cancelToken.cancel(message);
        aborted.value = true;
        isLoading.value = false;
        isFinished.value = false;
    };
    instance(url, Object.assign(Object.assign({}, config), { cancelToken: cancelToken.token }))
        .then((r) => {
        response.value = r;
        data.value = r.data;
    })
        .catch((e) => {
        error.value = e;
    })
        .finally(() => {
        isLoading.value = false;
        isFinished.value = true;
    });
    return {
        response,
        data,
        error,
        finished: isFinished,
        loading: isLoading,
        isFinished,
        isLoading,
        cancel: abort,
        canceled: aborted,
        aborted,
        abort,
    };
}

export { useAxios };
